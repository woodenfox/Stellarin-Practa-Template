# External Submission API

Submit Practa ZIP files programmatically from external tools (like the Replit IDE plugin).

**Base URL:** `https://stellarin-practa-verification.replit.app`

## Two-Step Submission Flow

External tools can upload ZIPs without authentication, then redirect users to complete submission after login.

### Step 1: Upload Preview

Upload a ZIP file for validation. No authentication required.

```
POST /api/submissions/upload-preview
Content-Type: multipart/form-data
```

**Request Body:**
- `file` - The Practa ZIP file (max 10MB)

**Example (curl):**
```bash
curl -X POST https://stellarin-practa-verification.replit.app/api/submissions/upload-preview \
  -F "file=@my-practa.zip"
```

**Success Response (200):**
```json
{
  "token": "a1b2c3d4-e5f6-7890-abcd-ef1234567890",
  "practaName": "my-practa",
  "practaType": "breathwork",
  "version": "1.0.0",
  "validationChecks": [
    {
      "name": "Required Files",
      "category": "contract_compliance",
      "passed": true,
      "message": "All required files present"
    }
  ],
  "validationScore": 85,
  "aiFixInstructions": "Consider adding more documentation...",
  "expiresAt": "2025-12-28T08:30:00.000Z"
}
```

**Error Responses:**
- `400` - No file uploaded, invalid ZIP, or file too large
- `500` - Server error

### Step 2: Redirect User

After receiving the token, redirect the user to complete their submission:

```
https://stellarin-practa-verification.replit.app/submit?token={token}
```

The frontend will:
1. Save the token to localStorage
2. Prompt login if the user is not authenticated
3. Automatically claim the upload after authentication
4. Redirect to the submission details page

**Token expires in 30 minutes.**

### Step 3: Claim Upload (Optional Direct API)

If you need to claim programmatically (requires authenticated session):

```
POST /api/submissions/claim
Content-Type: application/json
Cookie: (session cookie from Replit Auth)
```

**Request Body:**
```json
{
  "token": "a1b2c3d4-e5f6-7890-abcd-ef1234567890"
}
```

**Success Response (200):**
```json
{
  "id": "submission-uuid",
  "practaName": "my-practa",
  "status": "analyzing",
  "validationScore": 85,
  ...
}
```

## ZIP File Requirements

Your ZIP should have a flat structure (files at root level):

```
my-practa.zip
├── index.tsx          (required) - Main component
├── metadata.json      (required) - Practa metadata
├── README.md          (required) - Documentation
├── assets.ts          (optional) - Asset declarations
└── assets/            (optional) - Asset files
    ├── background.png
    └── audio.mp3
```

### metadata.json Format

```json
{
  "id": "my-practa",
  "name": "My Practa",
  "version": "1.0.0",
  "description": "A guided breathing exercise",
  "author": "Your Name",
  "category": "breathwork",
  "tags": ["relaxation", "focus"],
  "estimatedDuration": 300
}
```

**Important:** The `id` field must be lowercase, start/end with alphanumeric characters, and contain only letters, numbers, hyphens, and underscores.

## Example Integration

```javascript
async function submitPracta(zipFile) {
  const formData = new FormData();
  formData.append("file", zipFile);

  const response = await fetch(
    "https://stellarin-practa-verification.replit.app/api/submissions/upload-preview",
    {
      method: "POST",
      body: formData,
    }
  );

  if (!response.ok) {
    const error = await response.json();
    throw new Error(error.message);
  }

  const result = await response.json();
  
  // Redirect user to complete submission
  const submitUrl = `https://stellarin-practa-verification.replit.app/submit?token=${result.token}`;
  window.open(submitUrl, "_blank");
  
  return result;
}
```

## Validation Checks

Submissions are validated for:

| Category | Checks |
|----------|--------|
| **Code Safety** | No eval(), no obfuscated code, no external scripts |
| **Contract Compliance** | Required files present, default export, correct props interface |
| **Quality** | Documentation quality, component structure, asset declarations |

## Submission Status Flow

```
analyzing → ai_rejected (if AI finds issues)
         → pending (if AI passes, awaiting human review)
         → approved → published (to GitHub)
         → rejected (changes required)
```
