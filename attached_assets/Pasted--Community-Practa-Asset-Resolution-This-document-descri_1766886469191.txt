# Community Practa Asset Resolution

This document describes how assets work across the entire Practa ecosystem: local development, Practa Manager validation/publishing, and the Stellarin app.

## Overview

The asset system provides a unified interface that works identically in all environments:
- **Local development**: Assets loaded via bundler (Vite/webpack `require()`)
- **Practa Manager**: Assets uploaded to Replit Object Storage during publish
- **Stellarin app**: Assets resolved from storage URLs at runtime

## ZIP Structure (Flat, Files at Root)

```
my-practa.zip
├── index.tsx          # Main component (required)
├── metadata.json      # Practa metadata (required)
├── README.md          # Documentation (required)
├── assets.ts          # Asset declarations (optional)
└── assets/            # Asset files folder (optional)
    ├── background.png
    ├── icon.svg
    └── sounds/
        └── click.mp3
```

## Asset Declaration (assets.ts)

### Local Development Version

In your Practa Template, declare assets using `require()`:

```typescript
// assets.ts - LOCAL DEVELOPMENT VERSION
// This file is transformed by Practa Manager during publish

const localAssets = {
  "background": require("./assets/background.png"),
  "icon": require("./assets/icon.svg"),
  "click-sound": require("./assets/sounds/click.mp3"),
};

export const assets = (key: keyof typeof localAssets) => localAssets[key];
```

### Published Version (Auto-Generated)

When published, Practa Manager generates a version with full URLs:

```typescript
// assets.ts - PUBLISHED VERSION (auto-generated by Practa Manager)
// DO NOT EDIT - This file is regenerated on each publish

import { createAssetResolver } from "@stellarin/practa-runtime";

export type AssetKey = "background" | "icon" | "click-sound";

const assetUrls: Record<AssetKey, string> = {
  "background": "https://storage.googleapis.com/replit-objstore-b74bc498-5f8d-4fca-b9ba-531f07dd1cd0/public/practa/my-practa/abc123/background.png",
  "icon": "https://storage.googleapis.com/replit-objstore-b74bc498-5f8d-4fca-b9ba-531f07dd1cd0/public/practa/my-practa/abc123/icon.svg",
  "click-sound": "https://storage.googleapis.com/replit-objstore-b74bc498-5f8d-4fca-b9ba-531f07dd1cd0/public/practa/my-practa/abc123/sounds/click.mp3",
};

export const assets = createAssetResolver(assetUrls);
```

## Using Assets in Components

The `assets()` function returns a string URL. Usage varies slightly by platform:

### Web Usage

```tsx
import { assets } from "./assets";

export default function MyPracta() {
  return (
    <div style={{ backgroundImage: `url(${assets("background")})` }}>
      <img src={assets("icon")} alt="Icon" />
      <audio src={assets("click-sound")} />
    </div>
  );
}
```

### React Native Usage (Stellarin App)

```tsx
import { Image, ImageBackground } from "react-native";
import { assets } from "./assets";

export default function MyPracta() {
  return (
    <ImageBackground source={{ uri: assets("background") }} style={styles.container}>
      <Image source={{ uri: assets("icon") }} style={styles.icon} />
    </ImageBackground>
  );
}
```

The API is identical across platforms - `assets(key)` always returns a string URL. Only the component usage differs (React Native requires the `{ uri: ... }` wrapper).

This code works identically in local development and when published.

## Asset Keys

Asset keys are derived from your `assets.ts` declarations:

| Declaration | Key |
|-------------|-----|
| `"background": require("./assets/bg.png")` | `background` |
| `"click-sound": require("./assets/audio/click.mp3")` | `click-sound` |

If assets exist in `./assets/` but aren't declared in `assets.ts`, keys are auto-generated from filenames:
- `assets/my-image.png` → `my-image`
- `assets/sounds/click.mp3` → `click`

## Supported Asset Formats

| Type | Extensions | Max Size |
|------|------------|----------|
| Images | `.png`, `.jpg`, `.jpeg`, `.gif`, `.webp`, `.svg`, `.ico` | 5 MB (1 MB for SVG/ICO) |
| Audio | `.mp3`, `.wav`, `.m4a`, `.ogg` | 10 MB |
| Video | `.mp4`, `.webm` | 50 MB |
| Fonts | `.woff`, `.woff2`, `.ttf`, `.eot` | 2 MB |
| Documents | `.pdf`, `.zip` | 10 MB |

## Validation

Practa Manager validates assets during submission:

1. **File Existence**: All files declared in `assets.ts` must exist in `./assets/`
2. **Size Limits**: Files must be under their type-specific limits
3. **Orphaned Files**: Warning if files exist but aren't declared (still uploaded)

## build.json

Published practas include a `build.json` with asset metadata:

```json
{
  "buildId": "abc123",
  "createdAt": "2025-01-15T10:30:00.000Z",
  "assets": {
    "background": "https://storage.googleapis.com/replit-objstore-b74bc498-5f8d-4fca-b9ba-531f07dd1cd0/public/practa/my-practa/abc123/background.png",
    "icon": "https://storage.googleapis.com/replit-objstore-b74bc498-5f8d-4fca-b9ba-531f07dd1cd0/public/practa/my-practa/abc123/icon.svg",
    "click-sound": "https://storage.googleapis.com/replit-objstore-b74bc498-5f8d-4fca-b9ba-531f07dd1cd0/public/practa/my-practa/abc123/sounds/click.mp3"
  }
}
```

## Storage URL Pattern

```
https://storage.googleapis.com/replit-objstore-b74bc498-5f8d-4fca-b9ba-531f07dd1cd0/public/practa/{slug}/{buildId}/{assetPath}
```

- `{slug}`: Derived from `metadata.id` (lowercase, alphanumeric + hyphens)
- `{buildId}`: Submission ID (unique per publish)
- `{assetPath}`: Path relative to `assets/` folder

## Stellarin App Integration

The Stellarin app should:

1. Fetch `build.json` for each installed practa
2. Use `createAssetResolver` from `@stellarin/practa-runtime` to resolve assets
3. The resolver returns storage URLs for use in components

### Example Runtime Implementation

```typescript
// @stellarin/practa-runtime
export function createAssetResolver<T extends string>(
  assetUrls: Record<T, string>
): (key: T) => string {
  return (key: T) => {
    const url = assetUrls[key];
    if (!url) {
      console.warn(`Asset "${key}" not found`);
      return "";
    }
    return url;
  };
}
```

## Template Recommendations

For the Practa Template:

1. **Include a sample `assets.ts`** with the local development pattern
2. **Add `.gitignore` for build artifacts** (the published `assets.ts` should never be committed)
3. **Document the asset key naming convention** (use kebab-case)
4. **Provide example assets** to demonstrate the workflow

### Sample Template Structure

```
practa-template/
├── index.tsx
├── metadata.json
├── README.md
├── assets.ts              # Local dev version with require()
├── assets/
│   └── .gitkeep           # Placeholder, users add their assets here
└── .replit                # Replit configuration
```

### Sample assets.ts for Template

```typescript
// assets.ts
// Declare your assets here using require() for local development
// Practa Manager will transform this to full URLs when published

const localAssets = {
  // Example: "my-image": require("./assets/my-image.png"),
} as const;

export type AssetKey = keyof typeof localAssets;

export const assets = (key: AssetKey): string => localAssets[key] as string;
```

## Migration Notes

If updating from an older asset system:

1. Move all assets to `./assets/` folder (flat structure at ZIP root)
2. Create `assets.ts` with `require()` declarations
3. Update component imports to use the `assets()` function
4. Test locally before submitting
